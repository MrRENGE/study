# 重排与重绘，及其性能提升优化

## 浏览器三棵树渲染过程

在通过HTTP 请求得到html 文件以后，浏览器进行相应的页面渲染过成。（有些大佬称为渲染过程中的三棵树，DOMTree、CSSOM、RenderTree），首先会迭代的解析 dom 节点构建dom 树，同时也会解析CSS构建CSSOM语法树，然后将者两棵树通过选择器规则进行融合生成一颗 RenderTree。详情看下图：

![image.png](https://cdn.nlark.com/yuque/0/2019/png/324010/1557905234136-be0353e4-5005-4dd2-9869-383bb18fb7f2.png)                             

过程总结：

1. 解析HTML构建DOMTree .
2. 解析css 构建CSS语法树（CSSOM）
3. 结合CSSOM合DOMTree 生成RenderTree。
4. 在渲染树上进行计算绘制成位图
5. 通过计算机操作系统底层进行位图渲染



## 重排与重绘

当dom节点的几何（布局）属性发生变化时，会触发节点的重新计算然后重新绘制渲染树这个过程称为重排（reflow）。重新生成的渲染树再次绘制到屏幕display这个过程称为　重绘（reprint）。重排合重绘会递归的遍历节点的然后经行计算，会带来很大的性能负担。

#### 引发重排的几个常见机制（节点的集合属性改变有哪些）

- 添加或者删除可见的节点
- 布局属性改变，元素布局位置发生变化
- 元素本身的尺寸发生变化
- 内容发生改变，
- 页面初始化会有一次渲染绘制（其实个人认为这不算重排重绘）
- 浏览器视口发生变化

## 性能优化方案

经典的虚拟DOM优化方案，通过计算批量的节点几何属性修改然后一次完成节点的修改（依赖收集）。其实就是通过一次操作实现了多次的修改，将每次几何属性修改带来的重排重绘简化一次完成。

- 这也叫做最小重排重绘。比如通过 cssText 属性来涵盖多次的属性修改、直接修改类名（将修改的样式写入一个类中，修改类名完成）。
- 新增节点情况下。单节点时，将所以属性设置完成后经行一次挂载。多节点群时，使用 fragment 进行批量操作ｄｏｍ．
- 将节点脱离文档流然后经行多重操作后挂载回文档流。这会存在两次重排重绘，两种常见的解决方案。第一种`display：none；`

然后经行操作后还原回去。第二种，将节点克隆下来，在备份后的节点上进行更改然后将节点替换回去。

- 缓存布局信息。避免多次遍历节点。

注意：offset、clientTop等属性时，不遵循浏览器的队列化修改合批量运行优化方案。

