# TCP/IP连接和释放

TCP 是面向连接、可靠的字节流协议。因此在数据传输时先要通过三次握手建立连接，断开连接通过四次挥手。其实到底是维护了一个连接状态，因为每次发送的报文其实都是一样的传送方式以及字节流模式。

常见的几种状态：

- CLOSED：表示初始状态。对服务端和客户端双方都一样。
- LISTEN：表示监听状态。服务端调用了 listen 函数使其处于监听状态，此时可以开始 accept （接收）客户端的连接。
- SYN_SENT：表示客户端已经发送了 SYN 报文段，则会处于该状态。当客户端调用 connect 函数发起连接请求时，首先发 SYN 给服务端，然后自己进入 SYN_SENT 状态，并等待服务端发送 ACK+SYN 作为请求应答。
- SYN_RCVD：表示服务端收到客户端发送 SYN 报文段。服务端收到这个报文段后，进入 SYN_RCVD 状态，然后发送 ACK+SYN 给客户端。
- ESTABLISHED：表示 TCP 连接已经成功建立，通信双方可以开始传输数据。服务端发送完 ACK+SYN 并收到来自客户端的 ACK 后进入该状态，客户端收到来自服务器的 SYN+ACK 并发送 ACK 后也进入该状态。
- FIN_WAIT_1：表示主动关闭连接。无论哪方调用 close 函数发送 FIN 报文都会进入这个这个状态。
- FIN_WAIT_2：表示被动关闭方同意关闭连接。主动关闭连接方收到被动关闭方返回的 ACK 后，会进入该状态。
- TIME_WAIT：表示收到对方的 FIN 报文并发送了 ACK 报文，就等 2MSL 后即可回到 CLOSED 状态了。如果 FIN_WAIT_1 状态下，收到对方同时带 FIN 标志和 ACK 标志的报文时，可以直接进入 TIME_WAIT 状态，而无须经过 FIN_WAIT_2 状态。
- CLOSING：表示双方同时关闭连接。如果双方几乎同时调用 close 函数，那么会出现双方同时发送 FIN 报文的情况，就会出现 CLOSING 状态，表示双方都在关闭连接。
- CLOSE_WAIT：表示被动关闭方等待关闭。当收到对方调用 close 函数发送的 FIN 报文时，回应对方 ACK 报文，此时进入 CLOSE_WAIT 状态。
- LAST_ACK：表示被动关闭方发送 FIN 报文后，等待对方的 ACK 报文状态，当收到 ACK 后进入CLOSED状态。

## Tcp连接

### 单方向发送连接请求（三次握手）

![1557935927542](C:\Users\MrRen\AppData\Roaming\Typora\typora-user-images\1557935927542.png)



注：SYN：表示请求报文中的首部字段控制位，ACK：控制位、seq:表示序列化号（通常是随机的一组数字）、ack:确认应答号（根据收到对方的序列号+1） 

* 客户端向服务端发送连接请求，此时第一次建立连接因此控制字段`ACK=0 SYN = 1 seq = x ` 此处的x 是随机出来的。然后客户端进入 SYN_SENT 状态，第一次握手。
* 服务端收到请求报文后判断是否建立连接，同意建立连接则。回送报文`SYN=1 ACK=1 ack=x+1 seq = y`  报文中ACK 控制位置为1，应答号 ack 为收到报文序列号+1，同时发送自己的序列号。随即服务器端进入，SYN_RCVD 状态。这是第二次握手。
* 客户端收到服务端同意建立连接报文后，发送报文 ` ACK=1 ack = y+1`  。随即进入ESTABLISH 状态。服务端收到响应报文，验证通过后也进入   ESTABLISH  状态。这是第三次握手。





###  当两台主机同时发送请求

​	当双方都发送连接请求时，并不会建立两个连接。而是复用一个连接。

![1557937006680](C:\Users\MrRen\AppData\Roaming\Typora\typora-user-images\1557937006680.png)





